// DMS-managed configuration (included first so user overrides take precedence)
include "dms/colors.kdl"
include "dms/layout.kdl"
include "dms/alttab.kdl"
include "dms/binds.kdl"
include "dms/outputs.kdl"
include "dms/cursor.kdl"
include "dms/windowrules.kdl"

// Startup
spawn-at-startup "dms" "run"

config-notification {
    disable-failed
}

// General Settings
prefer-no-csd
screenshot-path "~/Pictures/Screenshots/%Y-%m-%d %H-%M-%S.png"

hotkey-overlay {
    skip-at-startup
}

// Input
input {
    keyboard {
        repeat-delay 200
        repeat-rate 35
        xkb {
            layout "us"
            options "caps:escape"
        }
    }

    touchpad {
        dwt
        natural-scroll
    }

    focus-follows-mouse
    workspace-auto-back-and-forth
}

// Cursor
cursor {
    hide-when-typing
    hide-after-inactive-ms 5000
}

// Overview
overview {
    backdrop-color "#1E1E2E"
    workspace-shadow {
        off
    }
}

gestures {
    hot-corners {
        off
    }
}

// Layout — DMS handles gaps, borders, focus-ring, corner-radius
// Only user-specific layout preferences here
layout {
    center-focused-column "never"

    preset-column-widths {
        proportion 0.33333
        proportion 0.5
        proportion 0.66667
    }

    default-column-width { proportion 0.5; }

    shadow {
        softness 30
        spread 5
        offset x=0 y=5
        color "#0007"
    }

    struts {}
}

// User keybinds (override DMS defaults where they differ)
binds {
    // Application Shortcuts
    Mod+Return hotkey-overlay-title="Terminal: Ghostty" { spawn "ghostty"; }
    Mod+Alt+Return hotkey-overlay-title="Terminal: Alacritty" { spawn "alacritty"; }
    Mod+B hotkey-overlay-title="Browser: Firefox" { spawn "firefox-developer-edition"; }
    Mod+Alt+B hotkey-overlay-title="Browser: Chrome" { spawn "google-chrome-stable" "--enable-features=TouchpadOverscrollHistoryNavigation"; }
    Mod+E hotkey-overlay-title="File Manager: Thunar" { spawn "thunar"; }
    Mod+Alt+E hotkey-overlay-title="File Manager: Yazi" { spawn "yazi"; }

    // Override DMS: MOD+J/K for workspace navigation (not window navigation)
    Mod+J { focus-workspace-down; }
    Mod+K { focus-workspace-up; }
    Mod+Shift+J { move-column-to-workspace-down; }
    Mod+Shift+K { move-column-to-workspace-up; }

    // Override DMS: MOD+Escape for overview, MOD+Tab for previous workspace
    Mod+Escape hotkey-overlay-title="Overview" repeat=false { toggle-overview; }
    Mod+Tab { focus-workspace-previous; }

    // Maximize-column remapped from MOD+M (DMS uses MOD+M for task manager)
    Mod+Shift+M { maximize-column; }

    // Screenshots (user prefers MOD+S over Print key)
    Mod+S { screenshot; }
    Mod+Shift+S { screenshot-screen write-to-disk=true; }
    Mod+Ctrl+S { screenshot-window write-to-disk=true; }

    // Color picker
    Mod+P { spawn "sh" "-c" "pgrep -x hyprpicker >/dev/null || hyprpicker"; }
}

// Alt+Tab override (use Alt instead of Super for window switching)
recent-windows {
    binds {
        Alt+Tab         { next-window scope="output"; }
        Alt+Shift+Tab   { previous-window scope="output"; }
        Alt+grave       { next-window filter="app-id"; }
        Alt+Shift+grave { previous-window filter="app-id"; }
    }
}

// DMS layer rules
layer-rule {
    match namespace="^quickshell$"
    place-within-backdrop true
}

layer-rule {
    match namespace="^dms:blurwallpaper$"
    place-within-backdrop true
}

// Animations
animations {
    workspace-switch {
        spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
    }
    window-open {
        duration-ms 200
        curve "ease-out-quad"
    }
    window-close {
        duration-ms 200
        curve "ease-out-cubic"
    }
    horizontal-view-movement {
        spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
    }
    window-movement {
        spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
    }
    window-resize {
        spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
    }
    config-notification-open-close {
        spring damping-ratio=0.6 stiffness=1200 epsilon=0.001
    }
    screenshot-ui-open {
        duration-ms 300
        curve "ease-out-quad"
    }
    overview-open-close {
        spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
    }
}

// Window Rules
window-rule {
    match app-id=r#"firefox$"# title="^Picture-in-Picture$"
    open-floating true
}

window-rule {
    match app-id=r#"firefox"#
    match app-id=r#"google-chrome"#
    match app-id=r#"code"#
    match app-id=r#"obsidian$"#
    open-maximized true
}

window-rule {
    match title=r#".*(Open|Save|Select).*"#
    open-floating true
    default-column-width { proportion 0.0; }
    max-width 800
    max-height 1000
}

window-rule {
    match title=r#".*File.*"#
    open-floating true
    default-column-width { proportion 0.0; }
    max-width 800
    max-height 1000
}

window-rule {
    match app-id=r#"org\.gtk\.FileChooserDialog"#
    open-floating true
    default-column-width { proportion 0.0; }
    max-width 800
    max-height 1000
}

window-rule {
    match title=r#".*Sign in - Google Accounts — Mozilla Firefox"#
    open-floating true
}

window-rule {
    match title=r#".*(Dialog|Properties|Preferences|Settings|Rename).*"#
    open-floating true
}

window-rule {
    match app-id=r#"zenity"#
    open-floating true
}

window-rule {
    match app-id=r#"org\.kde\.polkit-kde-authentication-agent-1"#
    open-floating true
}

window-rule {
    match title=r#".*Authentication.*"#
    open-floating true
}

window-rule {
    match app-id=r#"org\.keepassxc\.KeePassXC"# title=r#".*Auto-Type.*"#
    open-floating true
}

window-rule {
    match app-id=r#"Bitwarden"# title=r#".*unlock.*"#
    open-floating true
}

window-rule {
    match app-id=r#"nm-connection-editor"#
    open-floating true
}

window-rule {
    match app-id=r#"blueman-manager"#
    open-floating true
}

window-rule {
    match app-id=r#"pavucontrol"#
    open-floating true
}

window-rule {
    match app-id=r#"steam"# title=r#".*(Friends|Settings|Properties).*"#
    open-floating true
}

// DMS quickshell windows
window-rule {
    match app-id=r#"org.quickshell$"#
    open-floating true
}

// Environment
environment {
    DISPLAY null
    ELECTRON_OZONE_PLATFORM_HINT "auto"
    XDG_SESSION_TYPE "wayland"
    XDG_CURRENT_DESKTOP "niri"

    QT_QPA_PLATFORM "wayland"
    QT_QPA_PLATFORMTHEME "gtk3"
    QT_QPA_PLATFORMTHEME_QT6 "gtk3"
    QT_WAYLAND_DISABLE_WINDOWDECORATION "1"
    QT_AUTO_SCREEN_SCALE_FACTOR "1"

    GDK_BACKEND "wayland,x11"

    MOZ_ENABLE_WAYLAND "1"
    MOZ_DBUS_REMOTE "1"

    _JAVA_AWT_WM_NONREPARENTING "1"
    SDL_VIDEODRIVER "wayland"
    CLUTTER_BACKEND "wayland"

    VDPAU_DRIVER "va_gl"
    LIBVA_DRIVER_NAME "iHD"
}

debug {
    honor-xdg-activation-with-invalid-serial
}
